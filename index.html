<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #b6d5f5;
            min-height: 100vh;
        }
        .task-item {
            transition: all 0.2s ease;
            border-radius: 6px;
        }
        .task-item.completed {
            background-color: #f3f4f6;
            opacity: 0.7;
        }
        .task-item.completed span {
            text-decoration: line-through;
        }
        .task-description {
            display: none;
            font-size: 0.875rem;
            color: #4b5563;
        }
        .task-item:hover .task-description {
            display: block;
        }
        .toast {
            transition: opacity 0.5s ease;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        .dropdown {
            transition: all 0.3s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .dropdown.open {
            max-height: 500px;
            opacity: 1;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-semibold text-center text-gray-800 mb-6">To-Do List</h1>
        <div class="mb-4">
            <input id="taskInput" type="text" placeholder="Task title" class="w-full p-2 mb-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400" />
            <textarea id="taskDescription" placeholder="Task description" class="w-full p-2 mb-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none" rows="3"></textarea>
            <button onclick="addTask()" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition-colors flex items-center justify-center">
                <span id="addButtonText">Add Task</span>
                <svg id="loadingSpinner" class="hidden h-5 w-5 ml-2 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 8 0 0116 0 8 8 0 01-16 0z" />
                </svg>
            </button>
        </div>
        <button onclick="toggleTaskList()" id="toggleButton" class="w-full bg-blue-100 text-blue-800 p-2 rounded-md hover:bg-blue-200 transition-colors mb-4 flex items-center justify-between">
            <span>Tasks</span>
            <svg id="toggleIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </button>
        <ul id="taskList" class="dropdown space-y-2"></ul>
        <div id="toast" class="fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-md opacity-0 pointer-events-none"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
  apiKey: "",
  authDomain: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log('Firebase initialized successfully, db:', db);
        } catch (error) {
            console.error('Firebase initialization failed:', error.message, error.code);
            showToast(`Failed to initialize Firebase: ${error.message}`, true);
            document.getElementById('taskList').innerHTML = '<li class="text-center text-red-500">Firebase not initialized. Check console for details.</li>';
        }

        // Show toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md ${isError ? 'bg-red-500' : 'bg-blue-500'} text-white opacity-100`;
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 2000);
        }

        // Toggle task list dropdown
        window.toggleTaskList = function() {
            const taskList = document.getElementById('taskList');
            const toggleButton = document.getElementById('toggleButton');
            const toggleIcon = document.getElementById('toggleIcon');
            taskList.classList.toggle('open');
            toggleButton.classList.toggle('bg-blue-200');
            toggleIcon.innerHTML = taskList.classList.contains('open') ?
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />` :
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />`;
        };

        // Add task to Firestore
        window.addTask = async function() {
            if (!db) {
                showToast('Firestore not initialized.', true);
                return;
            }
            const taskInput = document.getElementById('taskInput');
            const taskDescription = document.getElementById('taskDescription');
            const addButtonText = document.getElementById('addButtonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const taskText = taskInput.value.trim();
            const descriptionText = taskDescription.value.trim();

            if (taskText === '') {
                showToast('Task title cannot be empty!', true);
                return;
            }

            try {
                addButtonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                await addDoc(collection(db, 'tasks'), {
                    text: taskText,
                    description: descriptionText,
                    completed: false,
                    createdAt: serverTimestamp()
                });
                taskInput.value = '';
                taskDescription.value = '';
                showToast('Task added successfully!');
            } catch (error) {
                console.error('Error adding task:', error.message, error.code);
                showToast(`Failed to add task: ${error.message}`, true);
            } finally {
                addButtonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        };

        // Load tasks from Firestore
        function loadTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '<li class="text-center text-gray-500">Loading tasks...</li>';

            if (!db) {
                console.error('Error loading tasks: Firestore not initialized');
                taskList.innerHTML = '<li class="text-center text-red-500">Firestore not initialized. Check Firebase config.</li>';
                showToast('Firestore not initialized.', true);
                return;
            }

            try {
                console.log('Starting loadTasks, db:', db);
                const q = query(collection(db, 'tasks'), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snapshot) => {
                    console.log('Snapshot received:', snapshot.docs.length, 'tasks');
                    taskList.innerHTML = '';
                    if (snapshot.empty) {
                        taskList.innerHTML = '<li class="text-center text-gray-500">No tasks yet!</li>';
                    }
                    snapshot.forEach(doc => {
                        const task = doc.data();
                        const li = document.createElement('li');
                        li.className = `task-item flex flex-col p-3 bg-white rounded-md shadow-sm hover:shadow-md ${task.completed ? 'completed' : ''}`;
                        li.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span onclick="toggleTask('${doc.id}', ${task.completed})" class="cursor-pointer font-medium text-gray-800">${task.text}</span>
                                <button onclick="deleteTask('${doc.id}')" class="text-red-500 hover:text-red-600 transition-colors">Delete</button>
                            </div>
                            ${task.description ? `<div class="task-description mt-1">${task.description}</div>` : ''}
                        `;
                        taskList.appendChild(li);
                    });
                }, (error) => {
                    console.error('Error in onSnapshot:', error.message, error.code);
                    taskList.innerHTML = '<li class="text-center text-red-500">Error loading tasks!</li>';
                    showToast(`Failed to load tasks: ${error.message}`, true);
                });
            } catch (error) {
                console.error('Error loading tasks:', error.message, error.code);
                taskList.innerHTML = '<li class="text-center text-red-500">Error loading tasks!</li>';
                showToast(`Failed to load tasks: ${error.message}`, true);
            }
        }

        // Toggle task completion
        window.toggleTask = async function(id, completed) {
            if (!db) {
                showToast('Firestore not initialized.', true);
                return;
            }
            try {
                await updateDoc(doc(db, 'tasks', id), {
                    completed: !completed
                });
                showToast('Task updated!');
            } catch (error) {
                console.error('Error updating task:', error.message, error.code);
                showToast(`Failed to update task: ${error.message}`, true);
            }
        };

        // Delete task
        window.deleteTask = async function(id) {
            if (!db) {
                showToast('Firestore not initialized.', true);
                return;
            }
            try {
                await deleteDoc(doc(db, 'tasks', id));
                showToast('Task deleted!');
            } catch (error) {
                console.error('Error deleting task:', error.message, error.code);
                showToast(`Failed to delete task: ${error.message}`, true);
            }
        };

        // Load tasks on page load
        if (db) {
            loadTasks();
        } else {
            document.getElementById('taskList').innerHTML = '<li class="text-center text-red-500">Firestore not initialized. Check Firebase config.</li>';
        }
    </script>
</body>
</html>